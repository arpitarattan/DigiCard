<!DOCTYPE html>
<html>
<head>
  <title>3D Postcard</title>
  <style>
    body, html {
      margin: 0;
      overflow: hidden;
      background: white;
      height: 100vh;
    }

    #layer-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
    }

    .layer, .bgd {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.05s;
      pointer-events: none;
    }

    #upload-form {
      position: absolute;
      top: 20px; left: 20px;
      z-index: 100;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 10px;
    }

    #motion-btn {
      position: absolute;
      top: 20px; left: 200px;
      z-index: 100;
      padding: 10px;
      border-radius: 10px;
      background: #0077ff;
      color: white;
      border: none;
    }
  </style>
</head>
<body>

<div id="upload-form">
  <input type="file" id="file" />
  <button onclick="upload()">Upload</button>
</div>

<button id="motion-btn">Enable Motion</button>
<div id="layer-container"></div>

<script>
let layerContainer = document.getElementById('layer-container');
let motionBtn = document.getElementById('motion-btn');

let motionX = 0, motionY = 0;
let targetX = 0, targetY = 0;

function upload() {
  const file = document.getElementById('file').files[0];
  const formData = new FormData();
  formData.append('file', file);

  fetch('/process-depth', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(json => {
    if (json.success) {
      showLayers(json.data.layers, json.data.original);
      motionBtn.style.display = 'block';
    }
  })
  .catch(err => console.error('Upload error', err));
}

function showLayers(layers, original) {
  layerContainer.innerHTML = '';  // Clear previous layers

  // Add background image
  const bg = document.createElement('img');
  bg.src = original;
  bg.className = 'bgd';
  bg.style.zIndex = 0;
  layerContainer.appendChild(bg);

  layers.sort((a, b) => a.depth - b.depth);  // Back to front

  layers.forEach((layer, i) => {
    const img = document.createElement('img');
    img.src = layer.image_url;
    img.className = 'layer';
    img.style.zIndex = 1 + i;
    img.dataset.depth = layer.depth;
    layerContainer.appendChild(img);
  });
}

motionBtn.addEventListener('click', () => {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {

    DeviceOrientationEvent.requestPermission()
      .then(state => {
        if (state === 'granted') {
          window.addEventListener('deviceorientation', handleTilt);
          motionBtn.style.display = 'none';
        } else {
          alert("Motion permission not granted.");
        }
      })
      .catch(console.error);

  } else {
    // Fallback if not needed
    window.addEventListener('deviceorientation', handleTilt);
    motionBtn.style.display = 'none';
  }
});

// Fallback for desktop: mouse movement
window.addEventListener('mousemove', e => {
  const x = (e.clientX / window.innerWidth - 0.5) * 60;
  const y = (e.clientY / window.innerHeight - 0.5) * 60;
  targetX = x;
  targetY = y;
});

function handleTilt(e) {
  const x = e.gamma || 0;
  const y = e.beta || 0;
  targetX = x * 2;
  targetY = y * 2;
}

function animateLayers() {
  // Smooth transition
  motionX += (targetX - motionX) * 0.05;
  motionY += (targetY - motionY) * 0.05;

  const layers = document.querySelectorAll('.layer, .bgd');
  layers.forEach((layer, i) => {
    const depth = parseFloat(layer.dataset.depth || (i + 1) * 0.5);
    const offsetX = motionX * depth;
    const offsetY = motionY * depth;
    layer.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
  });

  requestAnimationFrame(animateLayers);
}

animateLayers();  // start animation loop
</script>
</body>
</html>
